# node-mw-auto-bt-pan-connector

<br />

## ■ 概要

BT ペアリングされている DENEB が 1 台であることを検出したときに、自動的に BT PAN 接続を行うモジュールです。

<br />

## ■ 注意 

mw-auto-bt-pan-connector モジュールは、[bt-pairing-mw](https://github.com/S-MilkyWay/node-bt-pairing-mw) モジュールおよび [bt-pan-mw](https://github.com/S-MilkyWay/node-bt-pan-mw) モジュールを利用しますが、これらのモジュールを利用にあたっては、事前に SGMO さん提供のインストーラーで必要なファイルをインストールしておく必要があります。

### インストール手順

1. SGMO さん提供物一式（フォルダまるごと）を自分の PC にコピーします。
    * 提供物一式は下記フォルダにあります。
        * \\\\jps00004830.jp.sony.com\project\MilkyWay\share\SGMO\Bt4DP
1. インストーラーを実行します。
    * インストーラーには x86 環境用のものと x64 環境用のものとがあります。
        * Bt4DPMSI_x86_x.x.x.xxxxx_signed.msi
        * Bt4DPMSI_x64_x.x.x.xxxxx_signed.msi
    * x64 環境では、下記フォルダにインストールされます。
        * C:\Program Files\Sony\Bt4DPMSI\SBtPANLib
1. インストール先フォルダ内のファイルを開発時用ファイルで上書きします。
    * 下記の zip ファイルを展開してできるファイルで上書きします。
        * SBtPanLib_x.x.x.xxxxx_Release_for_Dev_x86_x64_signed.zip

<br />

## ■ メソッド一覧

- __isAvailable()__ - mw-auto-bt-pan-connector モジュールが利用可能かどうかを判定します。
- __emit(eventName, value)__ - イベントを発行します。
- __on(eventName, listener)__ - イベント リスナーを登録します。
- __once(eventName, listener)__ - 一回しか使用されないイベント リスナーを登録します。
- __removeListener(eventName, listener)__ - イベント リスナーを削除します。
- __doConnect()__ - BT PAN 接続の要求を行います。
- __isConnectedToDeneb(callback)__ - DENEB と BT PAN 接続されているかどうかを判定します。
- __getPairedDenebCount()__ - BT ペアリングされている DENEB の数を取得します。
- __suspend()__ - mw-auto-bt-pan-connector モジュールをサスペンドさせます。
- __resume()__ - mw-auto-bt-pan-connector モジュールをレジュームさせます。
- __enableAutoConnect()__ - 自動 BT PAN 接続を有効化します。
- __disableAutoConnect()__ - 自動 BT PAN 接続を無効化します。
- __startScanDevice(callback)__ - デバイス スキャンを開始します。
- __stopScanDevice(callback)__ - デバイス スキャンを停止します。
- __destroy(callback)__ - オブジェクトを破棄します。

<br />

## ■ イベント一覧

### :zap:__pairedDenebCountChanged__

BT ペアリングされている DENEB の数に変化があった場合に発行されるイベントです。

引数 pairedDenebCount には、現在 BT ペアリングされている DENEB の数が代入されます。

```js
const AutoBtPanConnector = require('mw-auto-bt-pan-connector');
const autoBtPanConnector = AutoBtPanConnector.getInstance();

autoBtPanConnector.on('pairedDenebCountChanged', function (pairedDenebCount) {
    console.log('pairedDenebCountChanged: ' + pairedDenebCount.toString());
});
```

### :zap:__connectStart__

BT PAN 接続処理が開始される前に発行されるイベントです。 

引数はありません。

```js
const AutoBtPanConnector = require('mw-auto-bt-pan-connector');
const autoBtPanConnector = AutoBtPanConnector.getInstance();

autoBtPanConnector.on('connectStart', function () {
    console.log('connectStart');
});
```

### :zap:__connectEnd__

BT PAN 接続処理が完了した後に発行されるイベントです。

引数 error には、処理が成功した場合には undefined、そうでない場合にはエラー情報が代入されます。

```js
const AutoBtPanConnector = require('mw-auto-bt-pan-connector');
const autoBtPanConnector = AutoBtPanConnector.getInstance();

autoBtPanConnector.on('connectEnd', function (error) {
    console.log('connectEnd: ' + error.toString());
});
```

### :zap:__connectBusy__

BT PAN 接続を要求した際に、すでに接続処理が行われていた場合に発行されるイベントです。

引数はありません。

```js
const AutoBtPanConnector = require('mw-auto-bt-pan-connector');
const autoBtPanConnector = AutoBtPanConnector.getInstance();

autoBtPanConnector.on('connectBusy', function () {
    console.log('connectBusy');
});
```

### :zap:__abnormalConditionOfPan__

BT PAN 接続処理が正しく処理できない状況（リカバリー不能な異常状態）であると判断された場合には、:zap:abnormalConditionOfPan イベントが発行されます。

引数はありません。

```js
const AutoBtPanConnector = require('mw-auto-bt-pan-connector');
const autoBtPanConnector = AutoBtPanConnector.getInstance();

autoBtPanConnector.on('abnormalConditionOfPan', function () {
    console.log('abnormalConditionOfPan');
});
```

<br />

## ■ インスタンスの取得

getInstance() で AutoBtPanConnector のインスタンスを取得することができます。

シングルトンとなっていて、常に同じインスタンスが返されます。

### メイン プロセスからの取得方法

```js
const AutoBtPanConnector = require('mw-auto-bt-pan-connector');
const autoBtPanConnector = AutoBtPanConnector.getInstance();
```

### レンダラ― プロセスからの取得方法

レンダラー プロセスからメイン プロセスの mw-auto-bt-pan-connector モジュールにアクセスしたい場合には、レンダラ― プロセスにおいて、下記のように mw-auto-bt-pan-connector モジュールを取得してください。

```js
const AutoBtPanConnector = require('electron').remote.require('mw-auto-bt-pan-connector');
const autoBtPanConnector = AutoBtPanConnector.getInstance();
```

<br />

## ■ インスタンスの破棄

destroy() で、インスタンスを破棄できます。

destroy() を呼び出すと、以降、AutoBtPanConnector の各メソッドは機能しなくなります。

アプリケーションの終了時に必ず呼び出してください。

```js
const AutoBtPanConnector = require('mw-auto-bt-pan-connector');
const autoBtPanConnector = AutoBtPanConnector.getInstance();

autoBtPanConnector.destroy(function (error) {
    if (!error) {
        console.log('destroyed');
    } else {
        console.log(error.toString());
    }
});
```

<br />

## ■ デバイス スキャンの開始

startScanDevice() で、デバイス スキャンを開始することができます。

デバイス スキャンを開始することで、DENEB の検出・接続が可能となります。

```js
const AutoBtPanConnector = require('mw-auto-bt-pan-connector');
const autoBtPanConnector = AutoBtPanConnector.getInstance();

autoBtPanConnector.startScanDevice(function (error) {
    if (!error) {
        console.log('started');
    } else {
        console.log(error.toString());
    }
});
```

<br />

## ■ デバイス スキャンの停止

stopScanDevice() で、デバイス スキャンを停止することができます。

デバイス スキャンを停止すると、DENEB の検出・接続ができなくなります。

デバイス スキャンの停止中は、enableAutoConnect() で自動 BT PAN 接続を有効化していたとしても、自動 BT PAN 接続は行われなくなります。

デバイス スキャンの停止中は、getPairedDenebCount() は 0 を返します。

デバイス スキャンの停止中は、doConnect() は失敗します。

デバイス スキャンの停止中は、isConnectedToDeneb() は false を返します。

```js
const AutoBtPanConnector = require('mw-auto-bt-pan-connector');
const autoBtPanConnector = AutoBtPanConnector.getInstance();

autoBtPanConnector.stopScanDevice(function (error) {
    if (!error) {
        console.log('stopped');
    } else {
        console.log(error.toString());
    }
});
```

<br />

## ■ 自動 BT PAN 接続の開始方法

enableAutoConnect() で、自動 BT PAN 接続を開始することができます。

自動 BT PAN 接続はバックグラウンドで行われます。

バックグラウンドで、BT PAN 接続が可能と判断されると、:zap:connectStart イベントが発行され、BT PAN 接続処理が開始されます。

BT PAN 接続処理が完了すると、成功・失敗に関わらず、:zap:connectEnd イベントが発行されます。

:zap:connectEnd イベントの引数 error で、BT PAN 接続の成功・失敗を判断することができます。成功の場合は undefined、そうでない場合は error オブジェクトが代入されてきます。

BT PAN 接続処理が開始されたとき、すでに doConnect() などにより BT PAN 接続処理中だった場合には、:zap:conenctBusy イベントが発行されます。

BT PAN 接続処理が正しく処理できない状況（リカバリー不能な異常状態）であると判断された場合には、:zap:abnormalConditionOfPan イベントが発行されます。

```js
const AutoBtPanConnector = require('mw-auto-bt-pan-connector');
const autoBtPanConnector = AutoBtPanConnector.getInstance();

autoBtPanConnector.on('connectStart', function () {
    console.log('connectStart');
});

autoBtPanConnector.on('connectEnd', function (error) {
    if (!error) {
        console.log('connectEnd (success)');
    } else {
        console.log('connectEnd (failure): ' + error.toString());
    }
});

autoBtPanConnector.on('connectBusy', function () {
    console.log('connectBusy');
});

autoBtPanConnector.on('abnormalConditionOfPan', function () {
    console.log('abnormalConditionOfPan');
});

autoBtPanConnector.enableAutoConnect();  
```

<br />

## ■ 自動 BT PAN 接続の停止方法

disableAutoConnect() で、自動 BT PAN 接続を開始することができます。

ただし、すでに実行中の BT PAN 接続処理はそのまま完了まで継続されます。

```js
const AutoBtPanConnector = require('mw-auto-bt-pan-connector');
const autoBtPanConnector = AutoBtPanConnector.getInstance();

// Do something ...

autoBtPanConnector.disableAutoConnect();
```

<br />

## ■ DENEB と BT PAN 接続されているかどうかの判定方法

isConnectedToDeneb() で、現在、DENEB と BT PAN 接続されているかどうかを判定できます。

BT PAN 接続判定の成功・失敗はコールバックの第 1 引数 error で判断することができます。成功の場合は undefined、そうでない場合は error オブジェクトが代入されてきます。

BT PAN 接続判定に成功した場合、コールバックの第 2 引数 connected で、接続・未接続を判断することができます。true の場合は接続、false の場合は未接続です。

```js
const AutoBtPanConnector = require('mw-auto-bt-pan-connector');
const autoBtPanConnector = AutoBtPanConnector.getInstance();

autoBtPanConnector.isConnectedToDeneb(function (error, connected) {
    if (!error) {
        if (connected) {
            console.log('connected');
        } else {
            console.log('not connected');
        }
    } else {
        console.log(error.toString());
    }
});
```

<br />

## ■ BT ペアリングされている DENEB の数の取得方法

### イベントで取得

BT ペアリングされている DENEB の数に変化があったとき、:zap:pairedDenebCountChanged イベントが発生します。

:zap:pairedDenebCountChanged イベントの引数 pairedDenebCount で、現在 BT ペアリングされている DENEB の数を知ることができます。

enableAutoConnect() で自動 BT PAN 接続が有効化されていない場合、:zap:pairedDenebCountChanged イベントは発生しません。

```js
const AutoBtPanConnector = require('mw-auto-bt-pan-connector');
const autoBtPanConnector = AutoBtPanConnector.getInstance();

autoBtPanConnector.on('pairedDenebCountChanged', function (pairedDenebCount) {
    console.log('pairedDenebCountChanged: ' + pairedDenebCount.toString());
});

autoBtPanConnector.enableAutoConnect();
```

### メソッドで取得

getPairedDenebCount メソッドでは、いつでも、自動 BT PAN 接続の有効/無効に関係なく、BT ペアリングされている DENEB の数を取得することができます。

```js
const AutoBtPanConnector = require('mw-auto-bt-pan-connector');
const autoBtPanConnector = AutoBtPanConnector.getInstance();

var pairedDenebCount = autoBtPanConnector.getPairedDenebCount();
console.log('pairedDenebCount: ' + pairedDenebCount.toString());
```

<br />

## ■ 明示的な BT PAN 接続の要求方法

doConnect() により、自動 BT PAN 接続の有効・無効にかかわらず、BT PAN 接続を要求することができます。

doConnect() により BT PAN 接続が要求されると、:zap:connectStart イベントが発行され、バックグラウンドで BT PAN 接続処理が開始されます。

BT PAN 接続処理が完了すると、成功・失敗に関わらず、:zap:connectEnd イベントが発行されます。

:zap:connectEnd イベントの引数 error で、BT PAN 接続の成功・失敗を判断することができます。成功の場合は undefined、そうでない場合は error オブジェクトが代入されてきます。

doConnect() により BT PAN 接続要求がなされたとき、すでに BT PAN 接続処理中だった場合には、:zap:conenctBusy イベントが発行されます。

doConnect() により BT PAN 接続要求がなされたとき、BT PAN 接続処理が正しく処理できない状況（リカバリー不能な異常状態）であると判断された場合には、:zap:abnormalConditionOfPan イベントが発行されます。

```js
const AutoBtPanConnector = require('mw-auto-bt-pan-connector');
const autoBtPanConnector = AutoBtPanConnector.getInstance();

autoBtPanConnector.on('connectStart', function () {
    console.log('connectStart');
});

autoBtPanConnector.on('connectEnd', function (error) {
    console.log('connectEnd: ' + error.toString());
});

autoBtPanConnector.on('connectBusy', function () {
    console.log('connectBusy');
});

autoBtPanConnector.on('abnormalConditionOfPan', function () {
    console.log('abnormalConditionOfPan');
});

autoBtPanConnector.doConnect();
```

<br />

## ■ OS のサスペンド/レジュームへの対応方法

[electron.powerMonitor](http://electron.atom.io/docs/api/power-monitor/) で、OS の :zap:suspend イベントおよび :zap:resume イベントをハンドリングすることができます。

ここでは、メイン プロセスでのハンドリング方法を記します。

```js
const electron = require('electron');

const AutoBtPanConnector = require('mw-auto-bt-pan-connector');
const autoBtPanConnector = AutoBtPanConnector.getInstance();

electron.app.on('ready', function () {
    electron.powerMonitor.on('suspend', function () {
        autoBtPanConnector.suspend();
    });

    electron.powerMonitor.on('resume', function () {
        autoBtPanConnector.resume();
    });
};
```

<br />

## ■ [補足] デバッグ情報の出力

Altair 起動時に環境変数 DEBUG を下記のように設定することで、mw-auto-bt-pan-connector のデバッグ情報を出力させることができます。

```shell-session
$ DEBUG=mw-auto-bt-pan-connector* electron ./ --debug
```
